import"./modulepreload-polyfill-B5Qt9EMX.js";import{S as A,P as B,W as _,B as b,b as x,a as C,c as k,A as P,V as E,O as G,G as R,T as U}from"./lil-gui.esm-C5Hipvuz.js";const t={model:0,stars:!0,darkMatter:!1,playing:!1,frame:0,speed:1,particleSize:.4,cdmStarColor:"#66ccee",cdmDarkColor:"#ee6677",sidmStarColor:"#ccbb44",sidmDarkColor:"#aa3377",resetCamera:()=>{c.reset()},resetSettings:()=>{r.reset()}};function W(){var a=128,e=document.createElement("canvas");e.width=a,e.height=a;var i=e.getContext("2d"),m=a/2,f=a/2,o=a/2;i.beginPath(),i.arc(m,f,o,0,2*Math.PI,!1),i.closePath(),i.fillStyle="#FFFFFF",i.fill();const F=new U(e);return F.needsUpdate=!0,F}const D=W();class y{constructor(e,i){this.path=e,this.pt=i,this.snapshots=[],this.currentIndex=0,this.geometry=new b,this.material=new k({color:16777215,size:.4,opacity:1,transparent:!1,map:D,blending:P,depthTest:!1}),this.mesh=new C(this.geometry,this.material),this.isInitialized=!1,this.playing=!1,this.playbackSpeed=1,this.currentTime=0,this.frameTime=1/60,this.alpha=0,this.snapshotBuffer=null}async loadSnapshot(e){if(this.snapshotBuffer===null)return console.error("trying to load snapshot before snapshotBuffer is read"),null;const i=16+e*this.snapshotSize;return new Float32Array(this.snapshotBuffer,i,this.pointsPerSnapshot*3)}updatePointCloud(e){this.geometry.setAttribute("position",new x(e,3)),this.geometry.attributes.position.needsUpdate=!0}async seekToFrame(e){e=Math.min(e,this.maxSnap),this.currentIndex=e,this.currentTime=this.currentIndex*this.frameTime,this.currentSnapshot=await this.loadSnapshot(e),this.nextSnapshot=await this.loadSnapshot(Math.min(e+1,this.maxSnap)),this.updatePointCloud(this.currentSnapshot)}async interpolatePositions(e,i,m){const f=new Float32Array(e.length);for(let o=0;o<e.length;o++)f[o]=e[o]+(i[o]-e[o])*m;return f}async initialize(){this.snapshotBuffer=await(await fetch(`/sgr-sidm-viz/${this.path}`)).arrayBuffer();const e=new DataView(this.snapshotBuffer,0,16);this.maxSnap=e.getUint32(0,!0)-1,this.pointsPerSnapshot=e.getUint32(4,!0),this.bytesPerPoint=e.getUint32(8,!0),this.snapshotSize=this.pointsPerSnapshot*this.bytesPerPoint;const i=await this.loadSnapshot(0);return i&&(this.updatePointCloud(i),this.isInitialized=!0),this.isInitialized}async animate(e){if(!this.isInitialized||!this.playing)return;if(!t.playing){this.playing=t.playing;return}this.currentTime+=e*this.playbackSpeed;const i=Math.floor(this.currentTime/this.frameTime);if(this.alpha=this.currentTime%this.frameTime/this.frameTime,i!==this.currentIndex){if(this.currentIndex=i,t.frame=i,this.currentIndex>=this.maxSnap){this.currentIndex=this.maxSnap,this.playing=!1;return}this.currentSnapshot=await this.loadSnapshot(this.currentIndex);const m=Math.min(this.currentIndex+1,this.maxSnap);this.nextSnapshot=await this.loadSnapshot(m)}if(this.currentSnapshot&&this.nextSnapshot){const m=await this.interpolatePositions(this.currentSnapshot,this.nextSnapshot,this.currentIndex===this.maxSnap?0:this.alpha);this.updatePointCloud(m)}}}const p=new A,H=window.innerWidth/window.innerHeight,u=new B(75,H,.1,1e3),d=new _({antialias:!0});d.setSize(window.innerWidth,window.innerHeight);d.setPixelRatio(window.devicePixelRatio);document.body.appendChild(d.domElement);const L=await(await fetch("/sgr-sidm-viz/data/mw_disk.bin")).arrayBuffer(),V=new Float32Array(L),I=new b;I.setAttribute("position",new x(V,3));const $=new C(I,new k({color:16777215,size:.1,opacity:.4,transparent:!0,map:D,blending:P,depthTest:!1}));p.add($);const v=new b,O=new Float32Array([-8,0,0]);v.setAttribute("position",new x(O,3));const j=new C(v,new k({color:16691788,size:2,opacity:1,transparent:!1,map:D,blending:P,depthTest:!1}));p.add(j);const n=new y("data/cdm_lr_star.bin","star");n.material.color.set(t.cdmStarColor);p.add(n.mesh);const l=new y("data/cdm_lr_dark.bin","dark");l.material.color.set(t.cdmDarkColor);p.add(l.mesh);const s=new y("data/sidm_lr_star.bin","star");s.material.color.set(t.sidmStarColor);p.add(s.mesh);const h=new y("data/sidm_lr_dark.bin","dark");h.material.color.set(t.sidmDarkColor);p.add(h.mesh);u.position.y=-200;u.up=new E(0,0,1);const c=new G(u,d.domElement);c.enableDamping=!0;c.dampingFactor=.05;c.screenSpacePanning=!1;c.minDistance=1;c.maxDistance=300;c.saveState();const r=new R,z=document.createElement("div");z.style="margin: 4px 0; padding: 0 4px;";const T=document.createElement("div");T.className="gui-message";T.innerHTML=`
    <p><b>Low-resolution animation</b></p>
    <p><a href="/sgr-sidm-viz/">Go back to the landing page</a></p>
    <p><a href="/sgr-sidm-viz/high-res-still/">Go to the high-resolution still</a></p>
`;z.append(T);r.$children.prepend(z);r.add(t,"resetCamera").name("Reset camera");r.add(t,"resetSettings").name("Reset settings");const N=r.add(t,"model",{CDM:0,SIDM:1}).name("DM model");r.add(t,"stars").name("Enable stars");r.add(t,"darkMatter").name("Enable DM");const M=r.addFolder("Playback controls"),X=M.add(t,"playing").onChange(a=>{n.playing=a,l.playing=a,s.playing=a,h.playing=a}).name("Playing");M.add(t,"speed",.1,2.5).onChange(a=>{n.playbackSpeed=a,l.playbackSpeed=a,s.playbackSpeed=a,h.playbackSpeed=a}).name("Speed");const w=M.add(t,"frame",0,442).step(1).onChange(a=>{n.seekToFrame(a),l.seekToFrame(a),s.seekToFrame(a),h.seekToFrame(a)}).name("Frame number"),g=r.addFolder("Colors");g.addColor(t,"cdmStarColor").name("CDM star color");g.addColor(t,"cdmDarkColor").name("CDM DM color");g.addColor(t,"sidmStarColor").name("SIDM star color");g.addColor(t,"sidmDarkColor").name("SIDM DM color");g.close();N.onChange(a=>{switch(a){case 0:w.max(442),w.updateDisplay();break;case 1:w.max(416),w.updateDisplay();break;default:console.error("unknwon model controller value",a)}});let S=0;function Y(a){const e=(a-S)/1e3;S=a,c.update(),n.mesh.visible=t.model===0&&t.stars,l.mesh.visible=t.model===0&&t.darkMatter,s.mesh.visible=t.model===1&&t.stars,h.mesh.visible=t.model===1&&t.darkMatter,n.animate(e),l.animate(e),s.animate(e),h.animate(e),t.playing&&(t.model===0&&!n.playing||t.model===1&&!s.playing)&&(t.playing=!1),X.updateDisplay(),w.updateDisplay(),d.render(p,u)}async function q(){await Promise.all([n.initialize(),l.initialize(),s.initialize(),h.initialize()]),S=performance.now(),d.setAnimationLoop(Y)}await q();window.addEventListener("resize",()=>{u.aspect=window.innerWidth/window.innerHeight,u.updateProjectionMatrix(),d.setSize(window.innerWidth,window.innerHeight),d.setPixelRatio(window.devicePixelRatio)});
