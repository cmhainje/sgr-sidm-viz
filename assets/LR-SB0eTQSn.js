import"./modulepreload-polyfill-B5Qt9EMX.js";import{S as D,P as M,W as v,B as S,b as x,a as b,c as P,A as k,V as A,O as B,G as _,T as G}from"./lil-gui.esm-C5Hipvuz.js";const a={model:0,stars:!0,darkMatter:!1,playing:!1,frame:0,speed:1,particleSize:.4,resetCamera:()=>{l.reset()}};function U(){var e=128,t=document.createElement("canvas");t.width=e,t.height=e;var i=t.getContext("2d"),p=e/2,f=e/2,n=e/2;i.beginPath(),i.arc(p,f,n,0,2*Math.PI,!1),i.closePath(),i.fillStyle="#FFFFFF",i.fill();const z=new G(t);return z.needsUpdate=!0,z}const F=U();class y{constructor(t,i){this.path=t,this.pt=i,this.snapshots=[],this.currentIndex=0,this.geometry=new S,this.material=new P({color:16777215,size:.4,opacity:1,transparent:!1,map:F,blending:k,depthTest:!1}),this.mesh=new b(this.geometry,this.material),this.isInitialized=!1,this.playing=!1,this.playbackSpeed=1,this.currentTime=0,this.frameTime=1/60,this.alpha=0,this.snapshotBuffer=null}async loadSnapshot(t){if(this.snapshotBuffer===null)return console.error("trying to load snapshot before snapshotBuffer is read"),null;const i=16+t*this.snapshotSize;return new Float32Array(this.snapshotBuffer,i,this.pointsPerSnapshot*3)}updatePointCloud(t){this.geometry.setAttribute("position",new x(t,3)),this.geometry.attributes.position.needsUpdate=!0}async seekToFrame(t){t=Math.min(t,this.maxSnap),this.currentIndex=t,this.currentTime=this.currentIndex*this.frameTime,this.currentSnapshot=await this.loadSnapshot(t),this.nextSnapshot=await this.loadSnapshot(Math.min(t+1,this.maxSnap)),this.updatePointCloud(this.currentSnapshot)}async interpolatePositions(t,i,p){const f=new Float32Array(t.length);for(let n=0;n<t.length;n++)f[n]=t[n]+(i[n]-t[n])*p;return f}async initialize(){this.snapshotBuffer=await(await fetch(`/sgr-sidm-viz/${this.path}`)).arrayBuffer();const t=new DataView(this.snapshotBuffer,0,16);this.maxSnap=t.getUint32(0,!0)-1,this.pointsPerSnapshot=t.getUint32(4,!0),this.bytesPerPoint=t.getUint32(8,!0),this.snapshotSize=this.pointsPerSnapshot*this.bytesPerPoint;const i=await this.loadSnapshot(0);return i&&(this.updatePointCloud(i),this.isInitialized=!0),this.isInitialized}async animate(t){if(!this.isInitialized||!this.playing)return;if(!a.playing){this.playing=a.playing;return}this.currentTime+=t*this.playbackSpeed;const i=Math.floor(this.currentTime/this.frameTime);if(this.alpha=this.currentTime%this.frameTime/this.frameTime,i!==this.currentIndex){if(this.currentIndex=i,a.frame=i,this.currentIndex>=this.maxSnap){this.currentIndex=this.maxSnap,this.playing=!1;return}this.currentSnapshot=await this.loadSnapshot(this.currentIndex);const p=Math.min(this.currentIndex+1,this.maxSnap);this.nextSnapshot=await this.loadSnapshot(p)}if(this.currentSnapshot&&this.nextSnapshot){const p=await this.interpolatePositions(this.currentSnapshot,this.nextSnapshot,this.currentIndex===this.maxSnap?0:this.alpha);this.updatePointCloud(p)}}}const c=new D,W=window.innerWidth/window.innerHeight,m=new M(75,W,.1,1e3),o=new v({antialias:!0});o.setSize(window.innerWidth,window.innerHeight);o.setPixelRatio(window.devicePixelRatio);document.body.appendChild(o.domElement);const R=await(await fetch("/sgr-sidm-viz/data/mw_disk.bin")).arrayBuffer(),E=new Float32Array(R),C=new S;C.setAttribute("position",new x(E,3));const H=new b(C,new P({color:16777215,size:.1,opacity:.4,transparent:!0,map:F,blending:k,depthTest:!1}));c.add(H);const I=new S,V=new Float32Array([-8,0,0]);I.setAttribute("position",new x(V,3));const L=new b(I,new P({color:16691788,size:2,opacity:1,transparent:!1,map:F,blending:k,depthTest:!1}));c.add(L);const s=new y("data/cdm_lr_star.bin","star");c.add(s.mesh);const d=new y("data/cdm_lr_dark.bin","dark");d.material.color.set("#FF0000");c.add(d.mesh);const r=new y("data/sidm_lr_star.bin","star");c.add(r.mesh);const h=new y("data/sidm_lr_dark.bin","dark");h.material.color.set("#FF0000");c.add(h.mesh);m.position.y=-200;m.up=new A(0,0,1);const l=new B(m,o.domElement);l.enableDamping=!0;l.dampingFactor=.05;l.screenSpacePanning=!1;l.minDistance=1;l.maxDistance=300;l.saveState();const w=new _,$=w.add(a,"model",{CDM:0,SIDM:1});w.add(a,"stars");w.add(a,"darkMatter");const T=w.addFolder("Playback"),O=T.add(a,"playing").onChange(e=>{s.playing=e,d.playing=e,r.playing=e,h.playing=e});T.add(a,"speed",.1,2.5).onChange(e=>{s.playbackSpeed=e,d.playbackSpeed=e,r.playbackSpeed=e,h.playbackSpeed=e});const u=T.add(a,"frame",0,442).step(1).onChange(e=>{s.seekToFrame(e),d.seekToFrame(e),r.seekToFrame(e),h.seekToFrame(e)});w.add(a,"resetCamera");$.onChange(e=>{switch(e){case 0:u.max(442),u.updateDisplay();break;case 1:u.max(416),u.updateDisplay();break;default:console.error("unknwon model controller value",e)}});let g=0;function j(e){const t=(e-g)/1e3;g=e,l.update(),s.mesh.visible=a.model===0&&a.stars,d.mesh.visible=a.model===0&&a.darkMatter,r.mesh.visible=a.model===1&&a.stars,h.mesh.visible=a.model===1&&a.darkMatter,s.animate(t),d.animate(t),r.animate(t),h.animate(t),a.playing&&(a.model===0&&!s.playing||a.model===1&&!r.playing)&&(a.playing=!1),O.updateDisplay(),u.updateDisplay(),o.render(c,m)}async function X(){await Promise.all([s.initialize(),d.initialize(),r.initialize(),h.initialize()]),g=performance.now(),o.setAnimationLoop(j)}await X();window.addEventListener("resize",()=>{m.aspect=window.innerWidth/window.innerHeight,m.updateProjectionMatrix(),o.setSize(window.innerWidth,window.innerHeight),o.setPixelRatio(window.devicePixelRatio)});
